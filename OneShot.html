<!doctype html>
<style>*{padding:0; margin: 0}</style>
<html>
    
<head>
    <meta charset="utf-8">
    <title>Hello World</title>
</head>
    <script src="pixi.min.js"></script>
    <script src="bump.js"></script>
    <body>
        <script type="text/javascript">
            //Aliases
            var Container = PIXI.Container,
                autoDetectRenderer = PIXI.autoDetectRenderer,
                loader = PIXI.loader,
                resources = PIXI.loader.resources,
                TextureCache = PIXI.utils.TextureCache,
                Texture = PIXI.Texture,
                Text = PIXI.Text,
                Graphics = PIXI.Graphics,
                Sprite = PIXI.Sprite;
        
            
            var message = new Text("heesdfsdflo", {fontFamily: "Arial", fontSize: 32, fill: "white"}
            );
            message.position.set(50,256);
            
            var bullets = [],
                boxes = [],
                targets = [], 
                targetsHit = [];   

            var state,
                shoot,
                angleGun,
                gameWidth = 512,
                gameHeight = 512,
                gameBorder = 10,
                bulletSpeed = 10,
                bulletBounce = 10,
                bulletHeight = 30,
                bulletWidth = 10,
                wallWidth = 50,
                wallHeight = 50,
                stage = new Container(),
                renderer = autoDetectRenderer(512,512);
            
            document.body.appendChild(renderer.view);
            
            loader
                .add("mario2.png")
                .load(setup);

            function setup(){
                var leftWall = new Graphics(),
                    topWall = new Graphics(),
                    rightWall = new Graphics(),
                    bottomWall = new Graphics(),
                    tracePath = new Graphics(),
                    gun = new Graphics();

                var path;
                
                leftWall.beginFill(0x66CCFF);
                leftWall.drawRect(0,0,10,512);
                leftWall.endFill();

                
                rightWall.beginFill(0x66CCFF);
                rightWall.drawRect(502,0,10,512);
                rightWall.endFill();
                
                topWall.beginFill(0x66CCFF);
                topWall.drawRect(0,0,512,10);
                topWall.endFill();
                topWall.xpos = 0;
                topWall.ypos = 0;
                
                bottomWall.beginFill(0x66CCFF);
                bottomWall.drawRect(0,510,512,2);
                bottomWall.endFill();

                
                gun.lineStyle(10,0xFFFFFF,1);
                gun.moveTo(256,520);
                gun.lineTo(256,482);

                createWalls(3);
                createTargets();

                // createWall(100,75,50,50);
                // createWall(250,75,50,50);
                // createWall(400,75,50,50);
                // createWall(50,256,50,50);
                // createWall(200,256,50,50);
                // createWall(350,256,50,50);
                // createWall(120,375,50,50);
                // // createWalls(350,350,50,50);
                createTarget(50,50);
                createTarget(450,450);


                document.body.addEventListener("mousemove", function (e){

                    angleGun = (Math.atan2((gameHeight - e.clientY) ,((gameWidth / 2) - e.clientX )));
                    path =  new createPath((gameWidth / 2), gameHeight, angleGun, bulletBounce, 10, 10, bulletSpeed);
                    path = getPathHits(path);
                    tracePath.clear();
                    tracePath.lineStyle(2, 0xFF0000, 1);
                    tracePath.moveTo((gameWidth / 2),gameHeight);
                    path.cords.forEach(function(cord){
                        tracePath.lineTo(cord.xpos, cord.ypos);
                    });

                    gun.clear(); 
                    gun.lineStyle(10,0xFFFFFF,1);
                    gun.moveTo(256,520);
                    gun.lineTo(256 - (30 * Math.cos(angleGun)) , 512 - (30 * Math.sin(angleGun))); 

                });
                
                document.body.addEventListener("click", function (e){
                    if(bullets.length == 0){
                        var angleBullet = (Math.atan2((gameHeight - e.clientY) ,((gameWidth / 2) - e.clientX )));
                        var bullet = new Graphics();
                    
                        bullet.beginFill(0x239569);
                        bullet.drawRect(0 , 0, 10, 10);
                        bullet.x= (gameWidth / 2) - (bulletHeight * Math.cos(angleBullet));
                        bullet.y = gameHeight - (bulletHeight * Math.sin(angleBullet));
                        bullet.xv = (Math.cos(angleBullet));
                        bullet.yv = (Math.sin(angleBullet));
                        bullet.bounce = bulletBounce;
                        bullet.endFill();
                        
                        bullets.push(bullet);
                        stage.addChild(bullet);
                    }
                });

                stage.addChild(leftWall);
                stage.addChild(rightWall);
                stage.addChild(topWall);
                stage.addChild(bottomWall);
                stage.addChild(gun);
                stage.addChild(message);
                stage.addChild(tracePath);

                renderer.render(stage);

                gameLoop();
            }

            function createWalls(numWalls){
                debugger;
                var xsplit = gameWidth / numWalls,
                    ysplit = (gameHeight - 60) / numWalls,
                    xPad = xsplit - wallWidth,
                    yPad = ysplit - wallHeight;
                
                for(var i = 0; i < numWalls; i++){
                    for(var j = 0; j < numWalls; j++){
                        debugger;
                        var randx = Math.floor(Math.random() * xPad) + 1;
                        var randy = Math.floor(Math.random() * yPad) + 1; 
                        createWall((i*xsplit) + randx , (j * ysplit) + randy, wallWidth, wallHeight);

                    }
                }


            }
            

            function createWall(x,y,w,h){
                var box = new Graphics();
                box.beginFill(0xF6CCFF);
                box.drawRect(x,y,w,h);
                box.xpos = x;
                box.ypos = y;
                box.endFill();

                boxes.push(box);
                stage.addChild(box);
            }

            function createTargets(){
                var randAngle = Math.floor(Math.random() * 175) + 5;
                message.text = randAngle;
                var targetPath =  new createPath((gameWidth / 2), gameHeight, randAngle, bulletBounce, 10, 10, bulletSpeed);
                targetPath = getPathHits(targetPath);
                // tracePath.clear();
                // tracePath.lineStyle(2, 0xFF0000, 1);
                // tracePath.moveTo((gameWidth / 2),gameHeight);
                targetPath.cords.forEach(function(cord){ 
                    console.log("x: " + cord.xpos + " y: " + cord.ypos)
                    // tracePath.lineTo(cord.xpos, cord.ypos);
                });
            }

            function createTarget(x ,y){   
                var target = new Sprite(resources["mario2.png"].texture);
                target.x = x;
                target.y = y;
                targets.push(target);
                stage.addChild(target);
            }
            
            function gameLoop(){
                requestAnimationFrame(gameLoop);
                bullets.forEach(function(bullet){
                    hitTarget(bullet);
                    hitBox(bullet);
                    hitWall(bullet);
                    if(bullet.bounce > 0){
                        bullet.x -= (bulletSpeed * bullet.xv);
                        bullet.y -= (bulletSpeed * bullet.yv);
                    }else{
                        bullet.clear();
                        bullets.pop();
                        if(targets.length == 0){
                            message.text = "win";
                        }else{
                            targetsHit.forEach(function(target){
                                targets.push(target);
                                stage.addChild(target);
                            });
                            targetsHit = [];
                        }
                    }
                });
                renderer.render(stage); 
            }

            function createPath(xpos, ypos, angle, bounce, width, height, speed){
                this.xpos = xpos;
                this.ypos = ypos;
                this.bulletWidth = width;
                this.bulletHeight = height;
                this.xv = Math.cos(angle);
                this.yv = Math.sin(angle);
                this.bulletSpeed = speed;
                this.angle = angle;
                this.bounce = bounce;
                this.cords = [];
            }
            
            function getPathHits(path){
                while(path.bounce > 0){
                    if(path.xpos < gameBorder || (path.xpos + path.bulletWidth) > (gameWidth - gameBorder)){
                        path.bounce--;
                        path.xv *= -1;
                        var cord = {
                            xpos: path.xpos,
                            ypos: path.ypos
                        }
                        path.cords.push(cord);
                    }
                    else if(path.ypos < gameBorder || (path.ypos) > gameHeight){
                        path.bounce--;
                        path.yv *= -1;  
                        var cord = {
                            xpos: path.xpos,
                            ypos: path.ypos
                        }
                        path.cords.push(cord);             
                    }else{
                        boxes.forEach(function(box){
                            //Check if there a collision happening
                            if((path.ypos + path.bulletHeight) > box.ypos && 
                                path.ypos < (box.ypos + box.height) && 
                                (path.xpos + path.bulletWidth) > box.xpos && 
                                path.xpos < (box.xpos + box.width)){
                                
                                //Find axis of collision
                                var vectorX = (path.xpos + Math.abs(path.bulletWidth / 2)) - (box.xpos + Math.abs(box.width / 2));
                                var vectorY = (path.ypos + Math.abs(path.bulletHeight / 2)) - Math.abs(box.ypos + (box.height / 2));
                                var totalHalfWidth = Math.abs(path.bulletWidth / 2) + Math.abs(box.width / 2);
                                var totalHalfHeight = Math.abs(path.bulletHeight /2 ) +  Math.abs(box.height / 2);
                                var overlapX = totalHalfWidth - Math.abs(vectorX);
                                var overlapY =  totalHalfHeight - Math.abs(vectorY);

                                //Collsion on Top/Bottom
                                if(overlapX >= overlapY){
                                    if(vectorY > 0){
                                        path.ypos += overlapY;
                                        
                                    }else{
                                        path.ypos -= overlapY;
                                        
                                    }
                                    path.yv *= -1;
                                    var cord = {
                                        xpos: path.xpos,
                                        ypos: path.ypos
                                    }
                                    path.cords.push(cord); 
                                }
                                //Collsion on Left/Right
                                else{
                                    if(vectorX > 0){
                                        path.xpos += overlapX;
                                    }else{
                                        path.xpos -= overlapX;
                                    }
                                    path.xv *= -1;
                                    var cord = {
                                        xpos: path.xpos,
                                        ypos: path.ypos
                                    }
                                    path.cords.push(cord); 
                                }
                                path.bounce--;
                            }
                        });
                    }
                    path.xpos -= (path.bulletSpeed * path.xv); 
                    path.ypos -= (path.bulletSpeed * path.yv);             
                }
                return path;   
            }
            
            function hitTarget(bullet){
                var hit, totalWidth, totalHeight, centerWidth, centerHeight;
                var deleteIndex = 0;
                message.text = targets.length;
                targets.forEach(function(target){
                    if((bullet.y  + bullet.height) > target.y && 
                        bullet.y < (target.y + target.height) && 
                        (bullet.x + bullet.width) > target.x && 
                        bullet.x < (target.x + target.width)){
                            stage.removeChild(target);
                            targets.splice(deleteIndex, 1);
                            targetsHit.push(target);
                    }else{
                        deleteIndex++;
                    }
                });
            } 

            function hitBox(bullet){
                boxes.forEach(function(box){
                    //Check for collision
                    if((bullet.y  + bullet.height) > box.ypos && 
                        bullet.y < (box.ypos + box.height) && 
                        (bullet.x + bullet.width) > box.xpos && 
                        bullet.x < (box.xpos + box.width)){
                            //Find axis of collision
                            var vectorX = (bullet.x + Math.abs(bullet.width / 2)) - (box.xpos + Math.abs(box.width / 2));
                            var vectorY = (bullet.y + Math.abs(bullet.height / 2) ) - Math.abs(box.ypos + (box.height / 2));
                            var totalHalfWidth = Math.abs(bullet.width / 2) + Math.abs(box.width / 2);
                            var totalHalfHeight = Math.abs(bullet.height / 2) + Math.abs(box.height / 2);
                            var overlapX = totalHalfWidth - Math.abs(vectorX);
                            var overlapY =  totalHalfHeight - Math.abs(vectorY);

                            //Collsion on Top/Bottom
                            if(overlapX >= overlapY){
                                if(vectorY > 0){
                                    bullet.y += overlapY;
                                    
                                }else{
                                    bullet.y -= overlapY;
                                }
                                    bullet.yv *= -1;
                            }
                            //Collision on left/right
                            else{
                                if(vectorX > 0){
                                    bullet.x += overlapX;
                                }else{
                                    bullet.x -= overlapX;
                                }
                                    bullet.xv *= -1;
                            }
                        bullet.bounce--;
                    }
                });
            }

            function hitWall(bullet) {
                if(bullet.x < gameBorder || (bullet.x + bulletWidth) > (gameWidth - gameBorder)){
                    bullet.bounce--;
                    bullet.xv *= -1;
                }
                if(bullet.y < gameBorder || bullet.y > gameHeight){
                    bullet.bounce--;
                    bullet.yv *= -1;
                }         
            }
            
        </script>
    </body>
</html>